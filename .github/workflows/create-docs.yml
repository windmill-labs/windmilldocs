name: Create Docs from PR

on:
  repository_dispatch:
    types: [create-docs]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  generate-and-pr:
    runs-on: ubicloud-standard-4
    env:
      PR_NUMBER: ${{ github.event.client_payload.pr_number }}
      SOURCE_REPO: ${{ github.event.client_payload.repo }}
      COMMENT_TEXT: ${{ github.event.client_payload.comment_text }}
      BRANCH_NAME: docs-update-for-${{ github.event.client_payload.repo }}-pr-${{ github.event.client_payload.pr_number }}

    steps:
      - uses: actions/create-github-app-token@v2
        id: app
        with:
          app-id: ${{ vars.INTERNAL_APP_ID }}
          private-key: ${{ secrets.INTERNAL_APP_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: |
            windmilldocs
            ${{ github.event.client_payload.repo }}

      - name: Comment on source PR - Starting
        env:
          GH_TOKEN: ${{ steps.app.outputs.token }}
        run: |
          gh pr comment "$PR_NUMBER" \
            --repo "windmill-labs/$SOURCE_REPO" \
            --body "ðŸ¤– Docs update started. [View workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"

      - name: Checkout windmilldocs
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app.outputs.token }}
          fetch-depth: 0

      - name: Run Claude Code Action
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_bots: "windmill-internal-app[bot]"
          prompt: |
            You are updating the Windmill documentation based on changes from a PR in another repo.

            ## Source PR
            - Repo: windmill-labs/${{ env.SOURCE_REPO }}
            - PR number: #${{ env.PR_NUMBER }}
            - User request: ${{ env.COMMENT_TEXT }}

            ## Step 1: Fetch PR details
            Use the gh CLI to get ALL details about the source PR:
            ```
            gh pr view ${{ env.PR_NUMBER }} --repo windmill-labs/${{ env.SOURCE_REPO }} --json title,body,files,comments,reviews
            gh pr diff ${{ env.PR_NUMBER }} --repo windmill-labs/${{ env.SOURCE_REPO }}
            ```
            Read the PR title, body, diff, changed files, and comments carefully. Understand what changed and why.

            ## Step 2: Read documentation guidelines
            Read AGENTS.md and writing_style_guide.md in this repo to understand the documentation conventions.

            ## Step 3: Find and update relevant docs
            Based on the PR changes and the user's request, search the docs/ directory to find relevant documentation files.
            Update existing files or create new ones as needed to reflect the changes from the source PR.
            Follow the conventions from AGENTS.md (MDX format, sentence case titles, backlinks, etc.).

            ## Step 4: Commit, push and open PR
            - Focus on accuracy: only document what the PR actually changes.
            - If the user included specific instructions after /docs, prioritize those.
            - If no documentation changes are needed, comment on the source PR (windmill-labs/${{ env.SOURCE_REPO }}#${{ env.PR_NUMBER }}) explaining why, and stop.
            - Your branch name should be: ${{ env.BRANCH_NAME }}
            - After making changes, git add, commit, push, and create a draft PR from that branch to main.
            - The PR title should be: docs: update for ${{ env.SOURCE_REPO }}#${{ env.PR_NUMBER }}
            - The PR body should link to the source PR: https://github.com/windmill-labs/${{ env.SOURCE_REPO }}/pull/${{ env.PR_NUMBER }}
            - If the branch already exists remotely, check it out and push additional commits.
            - If a PR already exists for the branch, just push new commits without creating another PR.
            - After creating or updating the PR, comment on the source PR (windmill-labs/${{ env.SOURCE_REPO }}#${{ env.PR_NUMBER }}) with a link to the docs PR.
          claude_args: |
            --allowedTools "Bash,WebFetch,WebSearch"
            --model opus
          timeout_minutes: "60"
        env:
          GH_TOKEN: ${{ steps.app.outputs.token }}
